<!DOCTYPE html>
<html>
<head>
    <title>Rota Planlama Uygulaması</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <!-- YENİ VE SANA ÖZEL API ANAHTARI BURAYA EKLENDİ -->
    <script src="https://api-maps.yandex.ru/2.1/?lang=tr_TR&apikey=99595591-45f5-4a92-af30-7a1b8691291e" type="text/javascript"></script>
    
    <style>
        :root {
            --bg-color: #2c3e50; --container-bg: #34495e; --input-bg: #2c3e50; --text-color: #ecf0f1; --primary-color: #3498db; --secondary-color: #95a5a6; --success-color: #2ecc71; --danger-color: #e74c3c; --timeline-color: #95a5a6; --border-color: #4a6572;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }
        #stops-container::before { content: ''; position: absolute; left: 10px; top: 20px; bottom: 20px; width: 3px; background-color: var(--timeline-color); opacity: 0.5; }
        .address-input-item::before { content: ''; position: absolute; left: -20px; top: 50%; transform: translateY(-50%); width: 13px; height: 13px; border-radius: 50%; background-color: var(--text-color); border: 3px solid var(--container-bg); z-index: 1; }
        [class*="ymaps-2"][class*="-suggest-item"] {
            background-color: var(--input-bg) !important; color: var(--text-color) !important; border-bottom: 1px solid var(--border-color) !important;
        }
        [class*="ymaps-2"][class*="-suggest-item_selected_yes"] {
            background-color: var(--primary-color) !important; color: white !important;
        }
        [class*="ymaps-2"][class*="-suggest-item__title"] {
            color: var(--text-color) !important;
        }
        [class*="ymaps-2"][class*="-suggest-item_selected_yes"] [class*="-suggest-item__title"] {
            color: white !important;
        }
        .container{background-color:var(--container-bg);box-shadow:0 4px 15px rgba(0,0,0,.4);border-radius:12px;padding:25px;margin:20px;width:100%;max-width:900px;display:flex;flex-direction:column;gap:20px}.header h1{color:var(--text-color);margin:0;font-size:2em}.address-inputs label{display:block;margin-bottom:8px;font-weight:600;color:var(--secondary-color)}.address-inputs input[type=text],.address-inputs input[type=number],.address-inputs select{width:calc(100% - 24px);padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:1em;background-color:var(--input-bg);color:var(--text-color)}.address-inputs input[type=text]:focus{border-color:var(--primary-color);outline:0}#stops-container{position:relative;padding-left:25px}.address-input-item{display:flex;align-items:center;margin-bottom:15px;gap:15px;background-color:transparent;border:0;padding:10px 0;position:relative}.address-input-item .stop-index{font-weight:700;color:var(--text-color);font-size:1.2em;width:30px;text-align:center}.stop-details{flex-grow:1}.stop-details input[type=text]{width:calc(100% - 24px)}.stop-eta{font-size:.9em;color:var(--secondary-color);margin-top:5px}.stop-actions{display:flex;align-items:center;gap:8px}.status-button{border-radius:50%;width:35px;height:35px;border:2px solid var(--secondary-color);background-color:transparent;color:var(--secondary-color);font-size:1.2em;cursor:pointer;transition:all .3s ease}.address-input-item.completed .status-button{background-color:var(--success-color);border-color:var(--success-color);color:#fff}.address-input-item.completed .stop-details input{text-decoration:line-through;color:var(--secondary-color)}.remove-stop-btn{background-color:var(--danger-color);color:#fff;border:0;border-radius:50%;width:30px;height:30px;font-size:1.2em;cursor:pointer;display:flex;justify-content:center;align-items:center;transition:background-color .2s ease}.action-btn{padding:12px 25px;border:0;border-radius:8px;font-size:1em;cursor:pointer;transition:background-color .2s ease,transform .1s ease;white-space:nowrap}.action-btn.primary{background-color:var(--primary-color);color:#fff}.action-btn.secondary{background-color:var(--secondary-color);color:#2c3e50}.action-btn.tertiary{background-color:var(--input-bg);color:var(--text-color);border:1px solid var(--border-color)}.status-message{background-color:#2c3e50;color:#ecf0f1;border:1px solid var(--border-color)}.status-message.error{background-color:#c0392b}.status-message.success{background-color:#27ae60}.map-container{border:1px solid var(--border-color)}.route-details{background-color:#2c3e50;border:1px solid var(--border-color);color:var(--success-color)}.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;font-size:1.5em;z-index:9999;text-align:center}.spinner{border:8px solid #f3f3f3;border-top:8px solid #3498db;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin-bottom:20px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@media (max-width:768px){.container{margin:10px;padding:15px}.action-buttons{flex-direction:column;gap:10px}.action-btn{width:100%;padding:10px}}
    </style>
</head>
<body>
    <div class="container"><div class="header"><h1>Servis Rota Planlayıcı</h1><div id="status-message" class="status-message"></div></div><div class="address-inputs"><div class="input-group"><label for="start-address">Başlangıç Adresi:</label><input type="text" id="start-address" placeholder="Başlangıç adresini girin..." autocomplete="off"></div><div id="stops-container"></div><div class="input-group" style="background-color:#2c3e50;padding:15px;border-radius:8px;border:1px solid var(--border-color)"><label for="new-stop-address" style="font-weight:700">Yeni Durak Ekle:</label><input type="text" id="new-stop-address" placeholder="Adresi buraya yazıp 'Durak Ekle' butonuna basın..."></div><button id="add-stop-btn" class="action-btn" style="width:100%;margin-top:10px;background-color:var(--success-color)">Durak Ekle</button><div class="input-group" style="margin-top:20px"><label for="end-address">Bitiş Adresi:</label><input type="text" id="end-address" placeholder="Bitiş adresini girin..." autocomplete="off"></div></div><div class="action-buttons"><button id="optimize-route-btn" class="action-btn primary">Rotayı Hesapla</button><button id="manual-sort-mode-btn" class="action-btn secondary">Manuel Sıralama Modu</button><button id="home-address-btn" class="action-btn tertiary">Eve Git</button><button id="shop-address-btn" class="action-btn tertiary">İşe (Dükkana) Git</button><button id="save-home-address-btn" class="action-btn tertiary">Ev Adresini Kaydet</button><div class="region-selection"><label>Servis Bölgeleri:</label><select id="region-select" multiple><option value="Kartal">Kartal</option><option value="Maltepe">Maltepe</option><option value="Ataşehir">Ataşehir</option><option value="Kadıköy">Kadıköy</option><option value="Ümraniye">Ümraniye</option><option value="Sancaktepe">Sancaktepe</option><option value="Pendik">Pendik</option><option value="Tuzla">Tuzla</option></select></div></div><div id="route-details" class="route-details"></div><div id="map" class="map-container"></div></div>
<script>
    ymaps.ready(init);let myMap,placemarks=[],currentRoute,stops=[],manualSortMode=!1;const SHOP_ADDRESS="Atalar, Ceylan Sk. no:5, 34862 Kartal/İstanbul, Türkiye",SHOP_COORDS=[40.900451,29.213233];let savedHomeAddress=localStorage.getItem("homeAddress")||"",savedHomeCoords=localStorage.getItem("homeCoords")?JSON.parse(localStorage.getItem("homeCoords")):null;const SERVICE_TYPES={Montaj:25,Arıza:40,Teslimat:15,Keşif:30,Diğer:25},LOADING_MESSAGES=["Bekle kardeş, rotayı hesaplıyorum...","Trafik canavarına meydan okuyoruz...","En kısa yoldan mı gidelim, en hızlısından mı?","Yandex'le pazarlık yapıyoruz...","Kahveni tazeledin mi?"];let loadingMessageInterval;const startAddressInput=document.getElementById("start-address"),endAddressInput=document.getElementById("end-address"),stopsContainer=document.getElementById("stops-container"),addStopBtn=document.getElementById("add-stop-btn"),optimizeRouteBtn=document.getElementById("optimize-route-btn"),manualSortModeBtn=document.getElementById("manual-sort-mode-btn"),homeAddressBtn=document.getElementById("home-address-btn"),shopAddressBtn=document.getElementById("shop-address-btn"),saveHomeAddressBtn=document.getElementById("save-home-address-btn"),routeDetailsDiv=document.getElementById("route-details"),statusMessageDiv=document.getElementById("status-message"),regionSelect=document.getElementById("region-select"),newStopAddressInput=document.getElementById("new-stop-address");function init(){myMap=new ymaps.Map("map",{center:SHOP_COORDS,zoom:10,controls:["zoomControl","fullscreenControl"]},{searchControlProvider:"yandex#search"}),loadAddressesFromLocalStorage(),updateMapPlacemarks()}function addStopInput(e="",t=SERVICE_TYPES.Diğer,o="Diğer",s=null,a=!1){const n=Date.now()+Math.random(),i=document.createElement("div");i.className="address-input-item",a&&i.classList.add("completed"),i.dataset.id=n;const d=document.createElement("span");d.className="stop-index";const l=document.createElement("div");l.className="stop-details";const c=document.createElement("input");c.type="text",c.value=e,c.dataset.stopId=n;const r=document.createElement("div");r.className="stop-eta",r.textContent="Rota hesaplanmadı",l.appendChild(c),l.appendChild(r);const m=document.createElement("div");m.className="stop-actions";const p=document.createElement("button");p.className="status-button",p.innerHTML="\u2713",p.title="Tamamlandı olarak işaretle";const u=document.createElement("button");u.className="remove-stop-btn",u.innerHTML="\xd7",m.appendChild(p),m.appendChild(u),i.appendChild(d),i.appendChild(l),i.appendChild(m),stopsContainer.appendChild(i);const g={id:n,address:e,coords:s,serviceTime:t,serviceType:o,element:i,completed:a};stops.push(g),p.addEventListener("click",()=>{g.completed=!g.completed,i.classList.toggle("completed"),saveAddressesToLocalStorage()}),u.addEventListener("click",()=>removeStop(n)),c.addEventListener("input",t=>{g.address=t.target.value,g.coords=null,saveAddressesToLocalStorage()}),c.addEventListener("focus",t=>setupYandexSuggest(t.target)),updateStopIndices(),saveAddressesToLocalStorage()}function saveAddressesToLocalStorage(){localStorage.setItem("startAddress",startAddressInput.value),localStorage.setItem("endAddress",endAddressInput.value),localStorage.setItem("stops",JSON.stringify(stops.map(t=>({address:t.address,coords:t.coords,serviceTime:t.serviceTime,serviceType:t.serviceType,completed:t.completed}))));const t=Array.from(regionSelect.selectedOptions).map(t=>t.value);localStorage.setItem("selectedRegions",JSON.stringify(t))}function loadAddressesFromLocalStorage(){startAddressInput.value=localStorage.getItem("startAddress")||SHOP_ADDRESS,endAddressInput.value=localStorage.getItem("endAddress")||SHOP_ADDRESS;const t=JSON.parse(localStorage.getItem("stops"));t&&(stops=[],t.forEach(t=>{addStopInput(t.address,t.serviceTime,t.serviceType,t.coords,t.completed)}))}function displayRouteDetailsAndEtas(t){let e=0;const o=Math.round(t.properties.get("duration").value/60),s=stops.filter(t=>!t.completed).reduce((t,e)=>t+(e.serviceTime||25),0);routeDetailsDiv.innerHTML=`<p><strong>Toplam Seyahat Süresi:</strong> ${formatMinutesToHoursMinutes(o)}</p><p><strong>Kalan Servis Süresi:</strong> ${formatMinutesToHoursMinutes(s)}</p><p><strong>Tahmini Toplam Süre:</strong> ${formatMinutesToHoursMinutes(o+s)}</p>`,routeDetailsDiv.style.display="block";const a=new Date,n=t.getWayPoints();stops.forEach((t,e)=>{const o=t.element.querySelector(".stop-eta");if(t.completed)return void(o.textContent="Bu durak tamamlandı.");const s=n.get(e+1);if(s){const t=Math.round(s.properties.get("duration").value/60),e=new Date(a.getTime()+6e4*t);o.textContent=`Tahmini Varış: ${e.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"})}`}})}addStopBtn.addEventListener("click",()=>{const t=newStopAddressInput.value.trim();""===t?(displayMessage("Lütfen eklemek için bir durak adresi girin.","error"),newStopAddressInput.focus()):(addStopInput(t,SERVICE_TYPES.Diğer,"Diğer"),newStopAddressInput.value="",newStopAddressInput.focus())});async function calculateAndDisplayRoute(){showLoadingOverlay("Bekle kardeş, rotayı hesaplıyorum..."),clearInterval(loadingMessageInterval),loadingMessageInterval=setInterval(()=>{const t=document.querySelector(".loading-overlay p");t&&(t.textContent=LOADING_MESSAGES[Math.floor(Math.random()*LOADING_MESSAGES.length)])},3e3);try{const t=await getCoordsFromAddress(startAddressInput.value),e=await getCoordsFromAddress(endAddressInput.value);if(!t)return displayMessage("Başlangıç adresi bulunamadı. Lütfen kontrol edin.","error"),void hideLoadingOverlay();if(!e)return displayMessage("Bitiş adresi bulunamadı. Lütfen kontrol edin.","error"),void hideLoadingOverlay();const o=[];for(const s of stops){if(s.address){let t=s.coords;t||(t=await getCoordsFromAddress(s.address))&&((s.coords=t),saveAddressesToLocalStorage()),t?o.push(t):displayMessage(`Durak adresi bulunamadı: ${s.address}.`,"error")}}const a=[t,...o,e];if(a.length<2)return displayMessage("Rota için en az 2 nokta gerekli.","error"),void hideLoadingOverlay();currentRoute&&myMap.geoObjects.remove(currentRoute),(currentRoute=new ymaps.multiRouter.MultiRoute({referencePoints:a,params:{routingMode:"auto",avoidTrafficJams:!0}},{boundsAutoApply:!0,wayPointFinishIconLayout:"default#image",wayPointFinishIconImageHref:"https://cdn-icons-png.flaticon.com/512/1155/1155981.png",wayPointFinishIconImageSize:[30,30],wayPointStartIconLayout:"default#image",wayPointStartIconImageHref:"https://cdn-icons-png.flaticon.com/512/1155/1155979.png",wayPointStartIconImageSize:[30,30],wayPointIconLayout:"default#image",wayPointIconImageHref:"https://cdn-icons-png.flaticon.com/512/1155/1155980.png",wayPointIconImageSize:[25,25],routeStrokeStyle:"solid",routeStrokeWidth:4,routeStrokeColor:"#3498db",routeActiveStrokeColor:"#2980b9",pinIconFillColor:"#3498db"})).model.events.add("requestsuccess",()=>{const t=currentRoute.getActiveRoute();t?(displayRouteDetailsAndEtas(t),updateMapPlacemarks(),displayMessage("Rota başarıyla hesaplandı!","success")):displayMessage("Rota bulunamadı. Adresleri kontrol edin.","error"),hideLoadingOverlay()}),myMap.geoObjects.add(currentRoute)}catch(t){displayMessage("Rota hesaplanırken hata: "+t.message,"error"),console.error("Rota hatası:",t),hideLoadingOverlay()}}function removeStop(t){stops=stops.filter(e=>e.id!==t),stopsContainer.querySelector(`[data-id="${t}"]`).remove(),updateStopIndices(),saveAddressesToLocalStorage()}function updateStopIndices(){stops.forEach((t,e)=>{t.element.querySelector(".stop-index").textContent=(e+1).toString().padStart(2,"0")})}function setupYandexSuggest(t){const e=new ymaps.SuggestView(t,{provider:{suggest:(e,t)=>{const o=Array.from(regionSelect.selectedOptions).map(t=>t.value);let s=e;return o.length>0&&(s=`${e}, ${o.join(" ")}`),ymaps.suggest(s,t)}}});e.events.add("select",async e=>{const o=e.get("item").value;t.value=o;const s=t.dataset.stopId,a=await getCoordsFromAddress(o);if(a){const t=stops.find(t=>t.id==s);t&&(t.address=o,t.coords=a,saveAddressesToLocalStorage())}else{displayMessage("Adres bulunamadı: "+o,"error");const t=stops.find(t=>t.id==s);t&&(t.coords=null)}})}async function getCoordsFromAddress(t){try{const e=(await ymaps.geocode(t)).geoObjects.get(0);return e?e.geometry.getCoordinates():null}catch(t){return console.error("Geocode hatası:",t),null}}function formatMinutesToHoursMinutes(t){if(isNaN(t)||t<0)return"0 dakika";const e=Math.floor(t/60),o=t%60;let s="";return e>0&&(s+=`${e} saat `),s+=`${o} dakika`,s.trim()}let messageTimeout;function displayMessage(t,e="info"){clearTimeout(messageTimeout),statusMessageDiv.textContent=t,statusMessageDiv.className=`status-message ${e}`,statusMessageDiv.style.display="block",messageTimeout=setTimeout(()=>{statusMessageDiv.style.display="none"},8e3)}function showLoadingOverlay(t){const e=document.createElement("div");e.className="loading-overlay",e.id="loading-overlay",e.innerHTML=`\n            <div class="spinner"></div>\n            <p>${t}</p>\n        `,document.body.appendChild(e)}function hideLoadingOverlay(){const t=document.getElementById("loading-overlay");t&&t.remove(),clearInterval(loadingMessageInterval)}optimizeRouteBtn.addEventListener("click",calculateAndDisplayRoute),window.addEventListener("load",()=>{setupYandexSuggest(startAddressInput),setupYandexSuggest(endAddressInput),setupYandexSuggest(newStopAddressInput)});
</script>
</body>
</html>
